---

- name: "SCORED | 1.7.1.1 | PATCH | Ensure SELinux is installed"
  package:
    name: libselinux
    state: present
  when:
  - rhel7cis_rule_1_7_1_1
  tags:
  - level1
  - scored
  - patch
  - rule_1.7.1.1

- name: "SCORED | 1.7.1.2 | PATCH | Ensure SELinux is not disabled in bootloader configuration"
  replace:
    dest: /etc/default/grub
    regexp: '(selinux|enforcing)\s*=\s*0\s*'
    follow: yes
  register: selinux_grub_patch
  ignore_errors: yes
  notify: generate new grub config
  when:
  - rhel7cis_rule_1_7_1_2
  tags:
  - level1
  - scored
  - patch
  - rule_1.7.1.2

- name: "SCORED | 1.7.1.3 | PATCH | Ensure SELinux policy is configured"
  selinux:
    conf: /etc/selinux/config
    policy: "{{ rhel7cis_selinux_pol }}"
    state: permissive
  when:
  - not rhel7cis_selinux_disable
  - rhel7cis_rule_1_7_1_3
  tags:
  - level1
  - scored
  - selinux
  - patch
      - rule_1.7.1.3

- name: "SCORED | 1.7.1.4 | PATCH | Ensure the SELinux state is enforcing or permissive"
  selinux:
      conf: /etc/selinux/config
      policy: "{{ rhel7cis_selinux_pol }}"
      state: permissive
  when:
      - not rhel7cis_selinux_disable
      - rhel7cis_rule_1_7_1_4
  tags:
      - level1
      - scored
      - selinux
      - patch
      - rule_1.7.1.4

- name: "SCORED | 1.7.1.5 | PATCH | Ensure the SELinux state is enforcing"
  selinux:
      conf: /etc/selinux/config
      policy: "{{ rhel7cis_selinux_pol }}"
      state: enforcing
  when:
      - not rhel7cis_selinux_disable
      - rhel7cis_rule_1_7_1_5
  tags:
      - level2
      - scored
      - selinux
      - patch
      - rule_1.7.1.5

- name: "SCORED | 1.7.1.6 | AUDIT | Ensure no unconfined daemons exist"
  block:
      - name: "SCORED | 1.7.1.6 | AUDIT | Ensure no unconfined daemons exist | Find the unconfined daemons"
        shell: ps -eZ | egrep "initrc" | egrep -vw "tr|ps|egrep|bash|awk" | tr ':' ' ' | awk '{ print $NF }'
        register: rhelcis_1_7_1_6_unconf_daemons
        failed_when: no
        changed_when: no
      - name: "SCORED | 1.7.1.6 | AUDIT | Ensure no unconfined daemons exist | Message on no unconfined daemones"
        debug:
            msg: "Good News! There are no unconfined daemons found on your system"
        when: rhelcis_1_7_1_6_unconf_daemons.stdout == ""

      - name: "SCORED | 1.7.1.6 | AUDIT | Ensure no unconfined daemons exist | Message on unconfined daemones"
        debug:
            msg: "Warning! You have unconfined daemons: {{ rhelcis_1_7_1_5_unconf_daemons.stdout_lines }}"
        when: rhelcis_1_7_1_6_unconf_daemons.stdout != ""
  when:
      - rhel7cis_rule_1_7_1_6
  tags:
      - level1
      - audit
      - rule_1.7.1.6

- name: "SCORED | 1.7.1.7 | PATCH | Ensure SETroubleshoot is not installed"
  package:
      name: setroubleshoot
      state: absent
  when:
      - rhel7cis_rule_1_7_1_7
  tags:
      - level1
      - scored
      - selinux
      - patch
      - rule_1.7.1.7

- name: "SCORED | 1.7.1.8 | PATCH | Ensure the MCS Translation Service (mcstrans) is not installed"
  package:
      name: mcstrans
      state: absent
  when:
      - rhel7cis_rule_1_7_1_8
  tags:
      - level1
      - scored
      - patch
      - rule_1.7.1.8
